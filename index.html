<!DOCTYPE html> 
<html manifest="joco.appcache"> 
	<head> 
	<title>JoCo Cruise Crazy II</title> 
	<meta name="viewport" content="width=device-width, initial-scale=1"> 
	<link rel="stylesheet" href="jquery.mobile/jquery.mobile-1.0.1.css" />
	<style type="text/css">
		.timespan {
			font-family: monospace;
			margin-right: 15px;
			font-size: smaller;
		}
	</style>
	<script src="jquery/jquery-1.7.1.js"></script>
	<script src="jquery.mobile/jquery.mobile-1.0.1.js"></script>
	<script src="jquery.Storage/jquery.Storage.js"></script>
	<script type="text/javascript">

  var cache = window.applicationCache;

  cache.addEventListener("cached", function () {
      console.log("All resources for this web app have now been downloaded. You can run this application while not connected to the internet");
  }, false);
  cache.addEventListener("checking", function () {
      console.log("Checking manifest");
  }, false);
  cache.addEventListener("downloading", function () {
      console.log("Starting download of cached files");
  }, false);
  cache.addEventListener("error", function (e) {
      console.log("There was an error in the manifest, downloading cached files or you're offline: " + e);
  }, false);
  cache.addEventListener("noupdate", function () {
      console.log("There was no update needed");
  }, false);
  cache.addEventListener("progress", function () {
      console.log("Downloading cached files");
  }, false);
  cache.addEventListener("updateready", function () {
      cache.swapCache();
      console.log("Updated cache is ready");
      // Even after swapping the cache the currently loaded page won't use it
      // until it is reloaded, so force a reload so it is current.
      window.location.reload(true);
      console.log("Window reloaded");
  }, false);

	var data = [];

	var months = [ 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December' ];

	// dateFormat.masks.joco = 'ddd, mmm d hh:MMTT';
	function formatTime(d) {
		var hour = String('0' + (d.getHours() % 12)).slice(-2);
		if (hour == '00') {
			hour = '12';
		}
		var ret = hour + ':' + String('0' + d.getMinutes()).slice(-2);
		if ((d.getHours() % 12) == d.getHours()) {
			ret += 'AM';
		} else {
			ret += 'PM';
		}
		return ret;
	}

	function formatDate(d) {
		return months[d.getMonth() - 1] + ' ' + d.getDate();
	}

	function refresh() {
		var html = "";
		var last_date = "";

		$.each(get(), function(i, entry) {
			var header = entry.title['$t'];
			var content = entry.content['$t'];

			if (entry['gd$when']) {
				var start = new Date(entry['gd$when'][0].startTime);
				var end   = new Date(entry['gd$when'][0].endTime);

				var startDate = formatDate(start);
				if (last_date != startDate) {
					html += '<li data-role="list-divider">' + startDate + '</li>' + "\n";
					last_date = startDate;
				}
				
				header += '<br /><span class="timespan">' + formatTime(start) + '-' + formatTime(end) + '</span>';
			}

			html += '<li>' + "\n" +
				'<div>' + "\n"
				+ '<h3>' + header + '</h3>' + "\n"
				+ '<p style="white-space:normal">' + content + '</p>' + "\n"
				+ '</div>' + "\n"
				+ '</li>' + "\n";
		});

		$('#entry-list').html(html);
		$('#entry-list').listview('refresh');
	}

	function get() {
		return $.Storage.loadItem("cache");
		/*
		var retval;
		if (supports_html5_storage() && supports_json()) {
			retval = window.JSON.parse(localStorage.getItem("cache"));
		} else {
			retval = data;
		}
		// console.log("retval = " + retval);
		return retval;
		*/
	}
	
	function save(obj) {
		return $.Storage.saveItem("cache", obj);
		/*
		if (supports_html5_storage() && supports_json()) {
			localStorage.setItem("cache", window.JSON.stringify(obj));
		} else {
			data = obj;
		}
		*/
	}

	$(document).ready(function () {//debugger;
	    $(document.body).bind("online", checkOnline);
	    $(document.body).bind("offline", checkOnline);
	    checkOnline();
	});

	function updateData() {
		console.log("update data");
		$.getJSON(
			"http://www.google.com/calendar/feeds/"
			+ "nh76o8dgn9d86b7n3p3uofg1q0%40group.calendar.google.com"
			+ "/public/full?alt=json-in-script"
			+ "&futureevents=true"
			+ "&orderby=starttime"
			+ "&sortorder=ascending"
			+ "&callback=?",
			function(json) {
				save(json.feed.entry);
				refresh();
			}
		);
	}

	function checkOnline() {
		if (navigator.onLine) {
			// Just because the browser says we're online doesn't mean we're online. The browser lies.
			// Check to see if we are really online by making a call for a static JSON resource on
			// the originating Web site. If we can get to it, we're online. If not, assume we're
			// offline.
			$.ajax({
				async: true,
				cache: false,
				context: $(document.body),
				dataType: "jsonp",
				timeout: 5000,
				type: "GET",
				url: "http://ranger.befunk.com/temp/JoCo/empty.txt",
				success: function (data, status, req) {
					console.log("success");
					updateData();
				},
				error: function (req, status, ex) {
					console.log("error");
					if (req.status == 200) {
						updateData();
						return;
					}
					console.log("Error: request = " + window.JSON.stringify(req) + ", status = " + status + ", ex = " + ex);
					// We might not be technically "offline" if the error is not a timeout, but
					// otherwise we're getting some sort of error when we shouldn't, so we're
					// going to treat it as if we're offline.
					// Note: This might not be totally correct if the error is because the
					// manifest is ill-formed.
					refresh();
				}
			});
		} else {
			console.log("not online");
			refresh();
		}
	}
	</script>
</head> 
<body> 

<div data-role="page">

	<!--
	<div data-role="header">
		<h1>JoCo Cruise Crazy II</h1>
	</div>
	-->

	<div data-role="content">	
		<ul id="entry-list" data-role="listview" data-filter="true" data-inset="true">
		</ul>
	</div>

</div>

</body>
</html>
