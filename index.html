<!DOCTYPE html> 
<html manifest="joco.appcache"> 
	<head> 
	<title>JoCo</title> 
	<meta name="viewport" content="width=device-width, user-scalable=no"> 
	<link rel="stylesheet" href="jquery.mobile/jquery.mobile-1.0.1.css" />
	<link rel="apple-touch-icon" href="apple-touch-icon.png" />
	<style type="text/css">
		.timespan {
			font-family: monospace;
			margin-right: 15px;
			font-size: smaller;
		}
	</style>
	<script src="jquery/jquery-1.7.1.js"></script>
	<script src="jquery.mobile/jquery.mobile-1.0.1.js"></script>
	<script src="jquery.Storage/jquery.Storage.js"></script>
	<script type="text/javascript">

  var cache = window.applicationCache;

  if (typeof cache != 'undefined') {
    cache.addEventListener("cached", function () {
        console.log("All resources for this web app have now been downloaded. You can run this application while not connected to the internet");
    }, false);
    cache.addEventListener("checking", function () {
        console.log("Checking manifest");
    }, false);
    cache.addEventListener("downloading", function () {
        console.log("Starting download of cached files");
    }, false);
    cache.addEventListener("error", function (e) {
        console.log("There was an error in the manifest, downloading cached files or you're offline: " + e);
    }, false);
    cache.addEventListener("noupdate", function () {
        console.log("There was no update needed");
    }, false);
		/*
    cache.addEventListener("progress", function () {
        console.log("Downloading cached files");
    }, false);
		*/
    cache.addEventListener("updateready", function () {
        cache.swapCache();
        console.log("Updated cache is ready");
        // Even after swapping the cache the currently loaded page won't use it
        // until it is reloaded, so force a reload so it is current.
        window.location.reload(true);
    }, false);
  }

	var timerInterval = undefined;
	var jocoOnline = false;

	var data = [];
	var pendingUpdates = [];
	
	var months = [ 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December' ];

	// dateFormat.masks.joco = 'ddd, mmm d hh:MMTT';
	function formatTime(d) {
		var hour = String('0' + (d.getUTCHours() % 12)).slice(-2);
		if (hour == '00') {
			hour = '12';
		}
		var ret = hour + ':' + String('0' + d.getUTCMinutes()).slice(-2);
		if ((d.getUTCHours() % 12) == d.getUTCHours()) {
			ret += 'AM';
		} else {
			ret += 'PM';
		}
		return ret;
	}

	function formatDate(d) {
		// console.log("month = " + d.getMonth());
		return months[d.getUTCMonth()] + ' ' + d.getUTCDate();
	}

	function getDateFromString(dateString) {
		// we retrieve in UTC, but the calendar schedule is set in EST (-05:00)
		return new Date((new Date(dateString)).valueOf() - (60 * 60 * 5 * 1000));
	}

	/*
	<input type="radio" name="type-choice" id="type-choice-official"   value="official" checked="checked" />
	<label for="type-choice-official">Official</label>
	<input type="radio" name="type-choice" id="type-choice-unofficial" value="unofficial" />
	*/

	function updateType(type) {
		setType(type);
		refresh();
		return true;
	}
	function setType(type) {
		if (type == undefined) {
			type = $("input[name='type-choice']:checked").val();
		}
		// console.log("setType value = " + type);
		save('calendarType', type);
		return true;
	}
	
	function getType() {
		var type = get('calendarType');
		if (type == 'official' || type == 'unofficial') {
			return type;
		}
		return 'official';
	}

	function refresh() {
		if ($.mobile.activePage.attr('id') != 'schedule') {
			console.log("skipping refresh, we're not on the schedule page");
			return;
		}

		var html = '';
		var last_date = '';
		var type = getType();
		
		$.each(get(type), function(i, entry) {
			var header = entry.title['$t'];
			var content = entry.content['$t'];

			if (entry['gd$when']) {
				var start = getDateFromString(entry['gd$when'][0].startTime.replace('.000-', '-'));
				var end   = getDateFromString(entry['gd$when'][0].endTime.replace('.000-', '-'));
				
				var startDate = formatDate(start);
				if (last_date != startDate) {
					html += '<li data-role="list-divider">' + startDate + '</li>' + "\n";
					last_date = startDate;
				}
				
				header += '<br /><span class="timespan">' + formatTime(start) + '-' + formatTime(end) + '</span>';
			}

			html += '<li>' + "\n" +
				'<div>' + "\n"
				+ '<h3 style="white-space:normal">' + header + '</h3>' + "\n"
				+ '<p style="white-space:normal">' + content + '</p>' + "\n"
				+ '</div>' + "\n"
				+ '</li>' + "\n";
		});

		$('#entry-list').html(html);
		if($.mobile.activePage.attr('id') == 'schedule') {
			$('#entry-list').listview('refresh');
			// $('#entry-list').listview();
		}
	}

	function get(name) {
		try {
			return $.Storage.loadItem(name);
		} catch (e) {
			console.log("failed to get " + name);
			return undefined;
		}
	}
	
	function save(name, obj) {
		// console.log("save name=" + name + ", obj = " + window.JSON.stringify(obj));
		return $.Storage.saveItem(name, obj);
	}

	function handlePendingUpdates() {
		if (pendingUpdates.length > 0) {
			var update = pendingUpdates.shift();
			if (jocoOnline) {
				console.log("handlePendingUpdates: update = " + update.name + ", URL = " + update.url);
				$.getJSON(update.url,
					function(json) {
						// console.log(window.JSON.stringify(json));
						save(update.name, json.feed.entry);
						handlePendingUpdates();
					}
				);
			} else {
				console.log("handlePendingUpdates: updates needed, but we are offline");
				handlePendingUpdates();
			}
		} else {
			console.log("handlePendingUpdates: no more updates needed");
			refresh();
			// $.mobile.hidePageLoadingMsg();
		}
	}
	
	function updateData() {
		pendingUpdates.push({name:"official", url:
			"http://www.google.com/calendar/feeds/"
			+ "nh76o8dgn9d86b7n3p3uofg1q0%40group.calendar.google.com"
			+ "/public/full?alt=json-in-script"
			+ "&ctz=Etc/UTC"
			+ "&orderby=starttime"
			+ "&sortorder=ascending"
			+ "&max-results=10000"
			+ "&start-min=2012-01-01T00:00:00-05:00"
			+ "&callback=?"
		});
		pendingUpdates.push({name:"unofficial", url:
			"https://www.google.com/calendar/feeds/"
			+ "6r0c1f3ltnhdlpbtpql79colos%40group.calendar.google.com"
			+ "/public/full?alt=json-in-script"
			+ "&ctz=Etc/UTC"
			+ "&orderby=starttime"
			+ "&sortorder=ascending"
			+ "&max-results=10000"
			+ "&start-min=2012-01-01T00:00:00-05:00"
			+ "&callback=?"
		});
		handlePendingUpdates();
	}

	function updateDataIfOnline() {
		jocoOnline = false;

		if (navigator.onLine) {
			// Just because the browser says we're online doesn't mean we're online. The browser lies.
			// Check to see if we are really online by making a call for a static JSON resource on
			// the originating Web site. If we can get to it, we're online. If not, assume we're
			// offline.
			$.ajax({
				async: true,
				cache: false,
				context: $(document.body),
				dataType: "jsonp",
				timeout: 5000,
				type: "GET",
				url: "http://www.raccoonfink.com/joco/online.html",
				success: function (data, status, req) {
					updateData();
				},
				error: function (req, status, ex) {
					if (jocoOnline) {
						updateData();
						return;
					}
					console.log("Error: request = " + window.JSON.stringify(req) + ", status = " + status + ", ex = " + ex);
					// We might not be technically "offline" if the error is not a timeout, but
					// otherwise we're getting some sort of error when we shouldn't, so we're
					// going to treat it as if we're offline.
					// Note: This might not be totally correct if the error is because the
					// manifest is ill-formed.
					refresh();
				}
			});
		} else {
			console.log("not online");
			refresh();
		}
	}

	function updateMapImage() {
//		alert("selected: " + $('#select-westerdam').val());
		$('#select-westerdam-image').attr('src', 'images/' + $('#select-westerdam').val());
		return false;
	}

	function onMenu(show) {
		console.log("onMenu");
		return true;
	}

	function onSchedule(show) {
		console.log("onSchedule");
		// $.mobile.showPageLoadingMsg();
		if (show) {
			updateDataIfOnline();
		} else {
		}
		return true;
	}

	function onMap(show) {
		console.log("onMap");
		return true;
	}

	function onDefault(show) {
		console.log("onDefault");
		return true;
	}

	$(document).bind('pageshow', function(event, data) {
		var activePage = $.mobile.activePage.attr('id');
		console.log('pageshow, active page = ' + activePage);

		switch(activePage) {
			case 'menu':     return onMenu(true);
			case 'schedule': return onSchedule(true);
			case 'map':      return onMap(true);
			default:         return onDefault(true);
		}
	});

	$(document).bind('pagebeforehide', function(event, data) {
		var activePage = $.mobile.activePage.attr('id');
		console.log('pagebeforehide, active page = ' + activePage);

		switch(activePage) {
			case 'menu':     return onMenu(false);
			case 'schedule': return onSchedule(false);
			case 'map':      return onMap(false);
			default:         return onDefault(false);
		}
	});

	$(document).ready(function() {
		$.mobile.defaultPageTransition = 'none';
		setType('official');
		updateDataIfOnline();
		// update every 60 minutes
		timerInterval = setInterval(updateDataIfOnline, 60 * 60 * 1000);
	});

	</script>
</head> 
<body> 

<div data-role="page" id="menu">
	<div data-role="header">
		<h1 style="white-space:normal">Cruisin'</h1>
	</div>
	
	<div data-role="content">
		<ul id="menu-list" data-role="listview" data-inset="true">
			<li><a href="#schedule">Schedule</a></li>
			<li><a href="#map">Map</a></li>
		</ul>
	</div>
</div>

<div data-role="page" id="schedule">

	<div data-role="header">
		<a href="#menu" data-rel="back" data-icon="arrow-l">Back</a>
		<h1 style="text-align:left; margin-left:10px; white-space:normal"></h1>
		<form id="chooser" data-role="controlgroup" data-type="horizontal" style="display:inline; margin-top:-5px; padding-top:0" class="ui-btn-right">
			<input type="radio" name="type-choice" id="type-choice-official"   value="official" checked="checked" onclick="javascript:updateType('official');" />
			<label for="type-choice-official">Official</label>
			<input type="radio" name="type-choice" id="type-choice-unofficial" value="unofficial" onclick="javascript:updateType('unofficial');" />
			<label for="type-choice-unofficial">Unofficial</label>
		</form>
	</div>

	<div data-role="content">	
		<ul id="entry-list" data-role="listview" data-filter="true" data-inset="true">
			<li>loading...</li>
		</ul>
	</div>

</div>

<div data-role="page" id="map">
	<div data-role="header">
		<a href="#menu" data-rel="back" data-icon="arrow-l">Back</a>
		<h1 style="white-space:normal">Westerdam Map</h1>
	</div>
	
	<div data-role="content">
		<select name="select-floor" id="select-westerdam" onChange="javascript:updateMapImage();">
			<option value="westerdam-11-sports.gif"                  >11 - Sports</option>
			<option value="westerdam-10-observation.gif"             >10 - Observation</option>
			<option value="westerdam-09-lido.gif" selected="selected">09 - Lido</option>
			<option value="westerdam-08-navigation.gif"              >08 - Navigation</option>
			<option value="westerdam-07-rotterdam.gif"               >07 - Rotterdam</option>
			<option value="westerdam-06-upper-verandah.gif"          >06 - Upper Verandah</option>
			<option value="westerdam-05-verandah.gif"                >05 - Verandah</option>
			<option value="westerdam-04-upper-promenade.gif"         >04 - Upper Promenade</option>
			<option value="westerdam-03-promenade.gif"               >03 - Promenade</option>
			<option value="westerdam-02-lower-promenade.gif"         >02 - Lower Promenade</option>
			<option value="westerdam-01-main.gif"                    >01 - Main Deck</option>
		</select>
		<img src="images/westerdam-09-lido.gif" id="select-westerdam-image" style="width:100%" />
	</div>
</div>

</body>
</html>
