<!DOCTYPE html> 
<html> 
	<head> 
	<title>JoCo Cruise Crazy II</title> 
	<meta name="viewport" content="width=device-width, initial-scale=1"> 
	<link rel="stylesheet" href="jquery.mobile/jquery.mobile-1.0.1.css" />
	<style type="text/css">
		.timespan {
			font-family: monospace;
			margin-right: 15px;
			font-size: smaller;
		}
	</style>
	<script src="jquery/jquery-1.7.1.js"></script>
	<script src="jquery.mobile/jquery.mobile-1.0.1.js"></script>
	<script type="text/javascript">

	var data = [];

	var months = [ 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December' ];

	// dateFormat.masks.joco = 'ddd, mmm d hh:MMTT';
	function formatTime(d) {
		var hour = String('0' + (d.getHours() % 12)).slice(-2);
		if (hour == '00') {
			hour = '12';
		}
		var ret = hour + ':' + String('0' + d.getMinutes()).slice(-2);
		if ((d.getHours() % 12) == d.getHours()) {
			ret += 'AM';
		} else {
			ret += 'PM';
		}
		return ret;
	}

	function formatDate(d) {
		return months[d.getMonth() - 1] + ' ' + d.getDate();
	}

	function supports_html5_storage() {
		try {
			if('localStorage' in window && window['localStorage'] !== null) {
				// console.log("yes HTML5 storage");
				return true;
			}
		} catch (e) {
		}
		// console.log("no HTML5 storage");
		return false;
	}
	
	function supports_json() {
		try {
			if ('JSON' in window && window['JSON'] !== null) {
				// console.log("yes JSON");
				return true;
			}
		} catch (e) {
		}
		// console.log("no JSON");
		return false;
	}

	function refresh() {
		var html = "";
		var last_date = "";

		$.each(get(), function(i, entry) {
			var header = entry.title['$t'];
			var content = entry.content['$t'];

			if (entry['gd$when']) {
				var start = new Date(entry['gd$when'][0].startTime);
				var end   = new Date(entry['gd$when'][0].endTime);

				var startDate = formatDate(start);
				if (last_date != startDate) {
					html += '<li data-role="list-divider">' + startDate + '</li>' + "\n";
					last_date = startDate;
				}
				
				header += '<br /><span class="timespan">' + formatTime(start) + '-' + formatTime(end) + '</span>';
			}

			html += '<li>' + "\n" +
				'<div>' + "\n"
				+ '<h3>' + header + '</h3>' + "\n"
				+ '<p style="white-space:normal">' + content + '</p>' + "\n"
				+ '</div>' + "\n"
				+ '</li>' + "\n";
		});

		$('#entry-list').html(html);
		$('#entry-list').listview('refresh');
	}

	function get() {
		var retval;
		if (supports_html5_storage() && supports_json()) {
			retval = window.JSON.parse(localStorage.getItem("cache"));
		} else {
			retval = data;
		}
		console.log("retval = " + retval);
		return retval;
	}
	
	function save(obj) {
		if (supports_html5_storage() && supports_json()) {
			localStorage.setItem("cache", window.JSON.stringify(obj));
		} else {
			data = obj;
		}
	}

	$.getJSON("http://www.google.com/calendar/feeds/nh76o8dgn9d86b7n3p3uofg1q0%40group.calendar.google.com/public/full?alt=json-in-script&futureevents=true&orderby=starttime&sortorder=ascending&callback=?",
		function(json) {
			save(json.feed.entry);
			refresh();
		}
	)
	.error(function() { refresh(); });
	
	</script>
</head> 
<body> 

<div data-role="page">

	<div data-role="header">
		<h1>JoCo Cruise Crazy II</h1>
	</div><!-- /header -->

	<div data-role="content">	
		<ul id="entry-list" data-role="listview" data-filter="true" data-inset="true">
		</ul>
	</div><!-- /content -->

</div><!-- /page -->

</body>
</html>
